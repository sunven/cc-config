name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  NODE_VERSION: '18'

jobs:
  # ====================
  # Code Quality Checks
  # ====================
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: Check TypeScript
        run: npx tsc --noEmit
        continue-on-error: false

      - name: Check code formatting (Prettier)
        run: npx prettier --check .
        continue-on-error: false

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Check Rust formatting
        run: cargo fmt -- --check
        continue-on-error: false

      - name: Run Clippy (Rust linter)
        run: cargo clippy --all-targets --all-features -- -D warnings
        continue-on-error: false

  # ====================
  # Unit & Integration Tests
  # ====================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        if: matrix.test-type == 'unit'
        run: npm test -- --run --coverage

      - name: Run integration tests
        if: matrix.test-type == 'integration'
        run: npm test -- --run src/tests
        continue-on-error: true

      - name: Upload coverage to Codecov
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # ====================
  # Accessibility Tests
  # ====================
  accessibility:
    name: Accessibility Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility tests
        run: |
          npm test -- --run src/__tests__/accessibility-detailed.test.tsx
          npm test -- --run src/tests/accessibility.test.tsx

      - name: Run Lighthouse CI
        run: |
          npm run lighthouse
        continue-on-error: true

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/

  # ====================
  # Security Tests
  # ====================
  security:
    name: Security Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security tests
        run: npm test -- --run src/__tests__/security.test.ts

      - name: Run npm audit
        run: npm audit --audit-level moderate
        continue-on-error: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Check for security vulnerabilities in Rust dependencies
        run: cargo audit
        continue-on-error: true

  # ====================
  # Performance Tests
  # ====================
  performance:
    name: Performance Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance tests
        run: npm test -- --run src/__tests__/performance.test.ts

      - name: Run benchmark suite
        run: npm run benchmark:quick
        continue-on-error: true

      - name: Run Lighthouse performance audit
        run: npm run lighthouse
        continue-on-error: true

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            performance-report.json
            memory-report.json

  # ====================
  # Cross-Platform Tests
  # ====================
  cross-platform:
    name: Cross-Platform Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run cross-platform tests
        run: npm test -- --run src/__tests__/cross-platform.test.ts

  # ====================
  # E2E Tests (Playwright)
  # ====================
  e2e:
    name: End-to-End Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build Tauri application
        run: npm run tauri build
        continue-on-error: true

      - name: Run E2E tests
        run: npm run test:e2e
        continue-on-error: true

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/

  # ====================
  # Build Application
  # ====================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint, test, accessibility, security, performance, cross-platform]
    strategy:
      matrix:
        platform: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Tauri
        uses: tauri-apps/setup-tauri@v2
        with:
          tauri-version: latest

      - name: Build application (debug)
        run: npm run tauri build --debug
        continue-on-error: true

      - name: Build application (release)
        run: npm run tauri build
        continue-on-error: false

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: |
            src-tauri/target/release/bundle/
            src-tauri/target/release/cc-config-viewer*

      - name: Upload macOS build (if macOS)
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: src-tauri/target/release/bundle/dmg/*.dmg

      - name: Upload Windows build (if Windows)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: src-tauri/target/release/bundle/msi/*.msi

      - name: Upload Linux build (if Ubuntu)
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb-appimage
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage

  # ====================
  # CodeQL Security Analysis
  # ====================
  codeql:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [javascript, rust]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Setup Node.js (for JavaScript)
        if: matrix.language == 'javascript'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (for JavaScript)
        if: matrix.language == 'javascript'
        run: npm ci

      - name: Setup Rust (for Rust)
        if: matrix.language == 'rust'
        uses: dtolnay/rust-toolchain@stable

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ====================
  # Publish Release (on release)
  # ====================
  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release summary
        run: |
          echo "## Release Assets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -la | grep -E '\.(dmg|msi|deb|AppImage)$' >> $GITHUB_STEP_SUMMARY

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            windows-msi/*.msi \
            macos-dmg/*.dmg \
            linux-deb-appimage/*.deb \
            linux-deb-appimage/*.AppImage \
            --repo ${{ github.repository }}

  # ====================
  # Notify (Slack/Discord)
  # ====================
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [build]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'release')
    steps:
      - name: Notify success
        if: needs.build.result == 'success'
        run: |
          echo "✅ Build completed successfully!" >> $GITHUB_STEP_SUMMARY

      - name: Notify failure
        if: needs.build.result == 'failure'
        run: |
          echo "❌ Build failed!" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
